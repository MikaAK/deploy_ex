server:
  http_listen_port: 3100
  grpc_listen_port: 0

clients:
  - url: {{ grafana_loki_url }}/loki/api/v1/push

positions:
  filename: /root/promtail_positions.yaml

scrape_configs:
  - job_name: journal
    journal:
      json: false
      max_age: 12h
      path: /var/log/journal
      labels:
        job: systemd-journal
    relabel_configs:
      - source_labels: ["__journal__systemd_unit"]
        target_label: "unit"

  - job_name: ec2-logs
    ec2_sd_configs:
      - region: us-east-2
        access_key: {{ aws_credentials['AWS_ACCESS_KEY_ID'] }}
        secret_key: {{ aws_credentials['AWS_SECRET_ACCESS_KEY'] }}

    relabel_configs:
      - source_labels: [__meta_ec2_tag_Name]
        target_label: name
        action: replace

      - source_labels: [__meta_ec2_instance_id]
        target_label: instance
        action: replace

      - source_labels: [__meta_ec2_availability_zone]
        target_label: zone
        action: replace

      - action: replace
        replacement: /var/log/**.log
        target_label: __path__

      - source_labels: [__meta_ec2_private_dns_name]
        regex: "(.*)"
        target_label: __host__
